namespace CarRentalSystem.Infrastructure.Persistence;

using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;

using CarRentalSystem.Domain.Common;

using Microsoft.EntityFrameworkCore;

internal class CarRentalDbInitializer : IInitializer
{
    private readonly CarRentalDbContext db;
    private readonly IEnumerable<IInitialData> initialDataProviders;

    public CarRentalDbInitializer(
        CarRentalDbContext db,
        IEnumerable<IInitialData> initialDataProviders)
    {
        this.db = db;
        this.initialDataProviders = initialDataProviders;
    }

    public void Initialize()
    {
        this.db.Database.Migrate();

        foreach (var initialDataProvider in this.initialDataProviders)
        {
            if (!this.DataSetIsEmpty(initialDataProvider.EntityType))
            {
                continue;
            }

            var data = initialDataProvider.GetData();
            this.db.AddRange(data);
        }

        this.db.SaveChanges();
    }

    private bool DataSetIsEmpty(Type type)
    {
        var setMethod = this.GetType()
            .GetMethod(nameof(this.GetSet), BindingFlags.Instance | BindingFlags.NonPublic)
            ?.MakeGenericMethod(type);

        var set = setMethod?.Invoke(this, Array.Empty<object>());

        var countMethod = typeof(Queryable)
            .GetMethods()
            .First(m => m.Name == nameof(Queryable.Count) && m.GetParameters().Length == 1)
            .MakeGenericMethod(type);

        var result = (int)countMethod.Invoke(null, new[] { set })!;

        return result is 0;
    }

    private DbSet<TEntity> GetSet<TEntity>()
        where TEntity : class
        => this.db.Set<TEntity>();
}
